{% extends "base.html" %}

{% block title %}Candle{% endblock %}

{% block content %}
<p><a href="/candle">Candles</a></p>
<div class="info">
    <div id="priceInfo"></div>
</div>
<div id="chart"></div>
<table border="1">
    <thead>
        <tr>
            <th>№</th>
            <th>exchange</th>
            <th>symbol</th>
            <th>interval</th>
            <th>timestamp</th>
            <th>open</th>
            <th>high</th>
            <th>low</th>
            <th>close</th>
            <th>volume</th>
            <th>quote_volume</th>
        </tr>
    </thead>
    <tbody>
        {% for (index, candle) in candles %}
        <tr>
            <td>{{ index }}</td>
            <td>{{ candle.exchange }}</td>
            <td>{{ candle.symbol }}</td>
            <td>{{ candle.interval }}</td>
            <td>{{ candle.timestamp }}</td>
            <td>{{ candle.open }}</td>
            <td>{{ candle.high }}</td>
            <td>{{ candle.low }}</td>
            <td>{{ candle.close }}</td>
            <td>{{ candle.volume }}</td>
            <td>{{ candle.quote_volume }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<div class="pin_time">{{ elapsed_ms }} ms</div>
<script>

    const chart = LightweightCharts.createChart(document.getElementById('chart'), {
        width: 1200,
        height: 650,
        layout: {
            backgroundColor: '#ffffff',
            textColor: '#333333',
        },
        grid: {
            vertLines: {
                color: '#f0f0f0',
            },
            horzLines: {
                color: '#f0f0f0',
            },
        },
        crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
        },
        rightPriceScale: {
            borderColor: '#cccccc',
            scaleMargins: {
                top: 0.1,
                bottom: 0.1,
            },
        },
        timeScale: {
            borderColor: '#cccccc',
            timeVisible: true,
            secondsVisible: false,
            barSpacing: 4,
        },
    });

    const candlestickSeries = chart.addCandlestickSeries({
        upColor: '#26a69a',
        downColor: '#ef5350',
        borderUpColor: '#26a69a',
        borderDownColor: '#ef5350',
        wickUpColor: '#26a69a',
        wickDownColor: '#ef5350',
    });

    const candleData = JSON.parse('{{ candles | json | safe }}').map(candle => ({
        time: candle.timestamp,
        open: parseFloat(candle.open),
        high: parseFloat(candle.high),
        low: parseFloat(candle.low),
        close: parseFloat(candle.close),
        volume: parseFloat(candle.volume)
    }));

    candlestickSeries.setData(candleData);

    chart.timeScale().fitContent();

    const priceInfo = document.getElementById('priceInfo');

    const candleMap = new Map();
    candleData.forEach(candle => {
        candleMap.set(candle.time, candle);
    });

    chart.subscribeCrosshairMove(param => {
        if (param.time && param.seriesPrices) {
            const seriesPrices = param.seriesPrices.get(candlestickSeries);
            if (seriesPrices) {
                const candle = candleMap.get(param.time);
                if (candle) {
                    const change = ((candle.close - candle.open) / candle.open * 100).toFixed(2);
                    const changeColor = candle.close >= candle.open ? '#26a69a' : '#ef5350';
                    const changeSymbol = candle.close >= candle.open ? '↗' : '↘';

                    priceInfo.innerHTML = `
                    <strong>Время:</strong> ${new Date(param.time * 1000).toLocaleString()} |
                    <strong>O:</strong> ${candle.open} |
                    <strong>H:</strong> ${candle.high} |
                    <strong>L:</strong> ${candle.low} |
                    <strong>C:</strong> ${candle.close} |
                    <strong style="color: ${changeColor}">${changeSymbol} ${change}%</strong>
                `;
                    return;
                }
            }
        }
        priceInfo.textContent = 'Наведите на свечу для просмотра деталей';
    });
</script>
{% endblock %}